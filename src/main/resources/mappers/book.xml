<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.library.repository.BookRepository">
    <select id="searchBook" parameterType="com.korit.library.web.dto.SearchReqDto" resultType="com.korit.library.web.dto.BookMstDto">
        SELECT <!--표기방식....알리아스 alias-->
            book_id as bookId,
            book_code as bookCode,
            book_name as bookName,
            author,
            publisher,
            publication_date as publicationDate,
            category
        from
            book_mst
        where
            1 = 1  <!-- 전체조회 편법 ㅎㅎ true를 놔둠으로 써 where아래가 없더라도 검색이 되게한다. -->

            <if test="searchValue != null">
                and	( <!--concat : mysql 문자열, 문자열을 합쳐준다-->
                        book_name like CONCAT('%', #{searchValue}, '%')  <!--searchValue 는 표현식으로 나중에 바뀜.-->
                    or author like CONCAT('%', #{searchValue}, '%')
                    or publisher like CONCAT('%', #{searchValue}, '%')
                )
            </if>

            <if test = "category != null">
                and category = #{category}    <!--쿼리 문법 : #{} -->
            </if>

        order by
            <choose> <!--else-->
                <when test = 'order == "bookName"'>book_name,</when><!-- '가나다 순' --> <!--when = else if-->
                <when test = 'order == "author"'>author,</when>
                <when test = 'order == "dateAsc"'>publication_date,</when>
                <when test = 'order == "dateDesc"'>publication_date desc,</when><!-- desc : 최신순 -->
                <!--<otherwise></otherwise> = else -->

            </choose>
                book_id

            <if test = 'limit == "Y"'>
                limit #{index},#{count} <!-- limit #{page번호}, #{수량} -->
            </if>
    </select>

    <select id = "findBookByBookCode" parameterType="String" resultType="com.korit.library.web.dto.BookMstDto"> <!--parameterType 생략가능-->
        SELECT <!--표기방식....알리아스 alias-->
            book_id as bookId,
            book_code as bookCode,
            book_name as bookName,
            author,
            publisher,
            publication_date as publicationDate,
            category
        from
            book_mst
        where
            book_code = #{bookCode};

    </select>

    <select id="findAllCategory" resultType="com.korit.library.web.dto.CategoryDto">
        select
            category_id,
            category
        from
            category_view
    </select>

    <insert id="saveBook" parameterType="com.korit.library.web.dto.BookReqDto">
        insert into book_mst
        values
            (0,#{bookCode}, #{bookName}, #{author},#{publisher},#{publicationDate},#{category})
    </insert>

    <!--put-->
    <update id = "updateBookByBookCode" parameterType="com.korit.library.web.dto.BookReqDto">
        update book_mst
        set
            book_name = #{bookName},
            author = if(#{author} = '',null,#{author}),
            publisher = if(#{publisher} = '',null,#{publisher}),
            publication_date = if(#{publicationDate} = '',null,#{publicationDate}),
            category = #{category}
        where
            book_code = #{bookCode}
    </update>

    <!--patch-->
    <update id = "maintainUpdateBookByBookCode" parameterType="com.korit.library.web.dto.BookReqDto">
        update book_mst
        set
            book_name = #{bookName},
            <if test = 'author != null and author !=""'>author = #{author},</if>
            <if test = 'publisher != null and publisher!=""'>publisher = #{publisher},</if>
            <if test = 'publicationDate != null'>publication_date = #{publicationDate},</if>
            category = #{category}
        where
            book_code = #{bookCode}
    </update>

    <delete id = "deleteBookByBookCode">
        delete
        from
            book_mst
        where
            book_code = #{bookCode}

    </delete>

    <insert id = "registerBookImages" parameterType="List">
        insert into book_image
        values
            <foreach collection = "list" item = "file" separator=","> <!--item = 변수명 -->
                (0, #{file.bookCode}, #{file.saveName}, #{file.originName})
            </foreach>

    </insert>

    <select id ="findBookImageAll" resultType="com.korit.library.web.dto.BookImageDto">
        select
            image_id as imageId,
            book_code as bookCode,
            save_name as saveName,
            origin_name as originName
        from
            book_image
        where
            book_code = #{bookCode}

    </select>
    <select id="findBookImageByImageId" resultType="com.korit.library.web.dto.BookImageDto">
        select
            image_id as imageId,
            book_code as bookCode,
            save_name as saveName,
            origin_name as originName
        from
            book_image
        where
            image_id = #{imageId}
    </select>

    <delete id = "deleteBookImage">
        delete
        from
            book_image
        where
            image_id = #{imageId};
    </delete>
</mapper>
